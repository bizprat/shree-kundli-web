---
/**
 * City Panchang Page
 *
 * Today's panchang for a specific city with:
 * - Answer-first tithi, nakshatra display (QuickAnswer)
 * - Context bar for navigation between panchang/rahu-kaal/choghadiya
 * - Glassmorphism cards
 * - Dataset schema for AI extraction
 */
// SSR: render on each request for fresh daily panchang data
export const prerender = false;

import Layout from '../../layouts/Layout.astro';
import Breadcrumb from '../../components/Breadcrumb.astro';
import GlassCard from '../../components/cards/GlassCard.astro';
import QuickAnswer from '../../components/data-display/QuickAnswer.astro';
import DataRow from '../../components/data-display/DataRow.astro';
import TimeDisplay from '../../components/data-display/TimeDisplay.astro';
import StatusBadge from '../../components/data-display/StatusBadge.astro';
import ContextBar from '../../components/navigation/ContextBar.astro';
import PopularCities from '../../components/sections/PopularCities.astro';
import type { BreadcrumbItem, City } from '../../lib/types';

// Load city data for lookup
import citiesData from '../../data/cities-sample.json';
const cities = citiesData as City[];

// Look up city from URL params
const { city: citySlug } = Astro.params;
const city = cities.find((c) => c.slug === citySlug);
if (!city) {
  return Astro.redirect('/404');
}

// Today's date
const today = new Date();
const todayFormatted = today.toLocaleDateString('en-IN', {
  weekday: 'long',
  day: 'numeric',
  month: 'long',
  year: 'numeric',
});
const todayIso = today.toISOString().split('T')[0];

// Mock panchang data (will be replaced with API data)
const panchang = {
  tithi: {
    name: 'Shukla Shashthi',
    paksha: 'Shukla',
    endTime: '05:15 AM (Next Day)',
  },
  nakshatra: {
    name: 'Rohini',
    lord: 'Moon',
    endTime: '08:42 PM',
  },
  yoga: {
    name: 'Shool',
    endTime: '11:23 AM',
  },
  karana: {
    name: 'Balava',
    endTime: '05:15 AM (Next Day)',
  },
  vara: {
    name: 'Monday',
    lord: 'Moon',
  },
  sun: {
    sunrise: '07:05 AM',
    sunriseIso: `${todayIso}T07:05:00+05:30`,
    sunset: '18:32 PM',
    sunsetIso: `${todayIso}T18:32:00+05:30`,
  },
  moon: {
    moonrise: '10:32 AM',
    moonset: '11:45 PM',
  },
  rahuKaal: {
    start: '07:30 AM',
    end: '09:00 AM',
    startIso: `${todayIso}T07:30:00+05:30`,
    endIso: `${todayIso}T09:00:00+05:30`,
  },
  yamaganda: {
    start: '10:30 AM',
    end: '12:00 PM',
  },
  gulikaKaal: {
    start: '01:30 PM',
    end: '03:00 PM',
  },
};

// Page meta
const title = `Today's Panchang for ${city.name} - ${todayFormatted} | Shreeng`;
const description = `${panchang.tithi.name} tithi, ${panchang.nakshatra.name} nakshatra. Sunrise ${panchang.sun.sunrise}, Rahu Kaal ${panchang.rahuKaal.start}-${panchang.rahuKaal.end}. Accurate panchang for ${city.name}.`;

// Breadcrumbs
const breadcrumbs: BreadcrumbItem[] = [
  { name: 'Home', url: '/' },
  { name: 'Panchang', url: '/panchang' },
  { name: city.name },
];

// Dataset schema for AI
const datasetSchema = {
  '@context': 'https://schema.org',
  '@type': 'Dataset',
  name: `Panchang for ${city.name} - ${todayFormatted}`,
  alternateName: `${city.name} Panchang - ${todayFormatted}`,
  description: `Vedic panchang data including tithi, nakshatra, yoga, karana, sunrise, sunset, and muhurat timings for ${city.name}.`,
  url: Astro.url.toString(),
  datePublished: todayIso,
  dateModified: todayIso,
  temporalCoverage: todayIso,
  spatialCoverage: {
    '@type': 'Place',
    name: `${city.name}, ${city.state}, India`,
    geo: {
      '@type': 'GeoCoordinates',
      latitude: city.latitude,
      longitude: city.longitude,
    },
  },
  variableMeasured: [
    { '@type': 'PropertyValue', name: 'Tithi', value: panchang.tithi.name },
    { '@type': 'PropertyValue', name: 'Nakshatra', value: panchang.nakshatra.name },
    { '@type': 'PropertyValue', name: 'Yoga', value: panchang.yoga.name },
    { '@type': 'PropertyValue', name: 'Karana', value: panchang.karana.name },
    { '@type': 'PropertyValue', name: 'Sunrise', value: panchang.sun.sunrise },
    { '@type': 'PropertyValue', name: 'Sunset', value: panchang.sun.sunset },
    { '@type': 'PropertyValue', name: 'Rahu Kaal', value: `${panchang.rahuKaal.start} - ${panchang.rahuKaal.end}` },
  ],
  creator: {
    '@type': 'Organization',
    name: 'Shreeng',
  },
  license: 'https://creativecommons.org/licenses/by/4.0/',
};

// FAQ schema
const faqSchema = {
  '@context': 'https://schema.org',
  '@type': 'FAQPage',
  mainEntity: [
    {
      '@type': 'Question',
      name: `What is today's tithi in ${city.name}?`,
      acceptedAnswer: {
        '@type': 'Answer',
        text: `Today (${todayFormatted}) is ${panchang.tithi.name} in ${city.name}. The tithi ends at ${panchang.tithi.endTime}.`,
      },
    },
    {
      '@type': 'Question',
      name: `What is Rahu Kaal time today in ${city.name}?`,
      acceptedAnswer: {
        '@type': 'Answer',
        text: `Rahu Kaal today in ${city.name} is from ${panchang.rahuKaal.start} to ${panchang.rahuKaal.end}. Avoid starting important activities during this period.`,
      },
    },
  ],
};
---

<Layout
  title={title}
  description={description}
  currentCity={city.name}
  currentCitySlug={city.slug}
  activeNav="panchang"
>
  <script is:inline type="application/ld+json" set:html={JSON.stringify(datasetSchema)} slot="head" />
  <script is:inline type="application/ld+json" set:html={JSON.stringify(faqSchema)} slot="head" />

  <div class="space-y-6">
    <!-- Breadcrumb -->
    <Breadcrumb items={breadcrumbs} />

    <!-- Page Header -->
    <header class="mb-2">
      <h1 class="text-2xl md:text-3xl font-bold">
        <span class="text-primary">{city.name}</span> Panchang
      </h1>
      <p class="text-sm text-neutral mt-1">
        <time datetime={todayIso}>{todayFormatted}</time> ‚Ä¢ {city.state}
      </p>
    </header>

    <!-- Context Bar (City + Date + Tabs) -->
    <ContextBar
      city={city.name}
      citySlug={city.slug}
      date={todayFormatted}
      activeTab="panchang"
    />

    <!-- Quick Answer (AI Extraction Target) -->
    <QuickAnswer highlight>
      <p>
        <strong>Today's Panchang for {city.name}</strong> ‚Äî
        Tithi: {panchang.tithi.name},
        Nakshatra: {panchang.nakshatra.name},
        Sunrise: <time datetime={panchang.sun.sunriseIso}>{panchang.sun.sunrise}</time>,
        Sunset: <time datetime={panchang.sun.sunsetIso}>{panchang.sun.sunset}</time>.
        Rahu Kaal: <time datetime={panchang.rahuKaal.startIso}>{panchang.rahuKaal.start}</time> - <time datetime={panchang.rahuKaal.endIso}>{panchang.rahuKaal.end}</time> (avoid new ventures).
      </p>
    </QuickAnswer>

    <!-- Main Panchang Data -->
    <section aria-label="Panchang Details">
      <h2 class="text-lg font-semibold mb-4 flex items-center gap-2">
        <span aria-hidden="true">üìÖ</span>
        <span>Panchangam</span>
      </h2>

      <GlassCard variant="elevated" padding="md">
        <DataRow
          label="Tithi"
          value={panchang.tithi.name}
          icon="üåô"
          href={`/tithi/${panchang.tithi.name.toLowerCase().replace(/\s+/g, '-')}`}
          variant="highlight"
        />
        <DataRow
          label="Paksha"
          value={panchang.tithi.paksha}
          icon="üåì"
        />
        <DataRow
          label="Nakshatra"
          value={panchang.nakshatra.name}
          icon="‚≠ê"
          href={`/nakshatra/${panchang.nakshatra.name.toLowerCase()}`}
        />
        <DataRow
          label="Yoga"
          value={panchang.yoga.name}
          icon="‚òØÔ∏è"
          href={`/yoga/${panchang.yoga.name.toLowerCase()}`}
        />
        <DataRow
          label="Karana"
          value={panchang.karana.name}
          icon="üìø"
        />
        <DataRow
          label="Vara"
          value={panchang.vara.name}
          icon="üìÜ"
          href={`/vara/${panchang.vara.name.toLowerCase()}`}
        />
      </GlassCard>
    </section>

    <!-- Sun & Moon Times -->
    <section aria-label="Sun and Moon Times" class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div>
        <h2 class="text-lg font-semibold mb-4 flex items-center gap-2">
          <span aria-hidden="true">‚òÄÔ∏è</span>
          <span>Sun Times</span>
        </h2>
        <GlassCard padding="md">
          <div class="grid grid-cols-2 gap-4">
            <TimeDisplay
              time={panchang.sun.sunrise}
              label="Sunrise"
              icon="üåÖ"
              datetime={panchang.sun.sunriseIso}
              variant="shubh"
            />
            <TimeDisplay
              time={panchang.sun.sunset}
              label="Sunset"
              icon="üåá"
              datetime={panchang.sun.sunsetIso}
            />
          </div>
        </GlassCard>
      </div>

      <div>
        <h2 class="text-lg font-semibold mb-4 flex items-center gap-2">
          <span aria-hidden="true">üåô</span>
          <span>Moon Times</span>
        </h2>
        <GlassCard padding="md">
          <div class="grid grid-cols-2 gap-4">
            <TimeDisplay
              time={panchang.moon.moonrise}
              label="Moonrise"
              icon="üåô"
            />
            <TimeDisplay
              time={panchang.moon.moonset}
              label="Moonset"
              icon="üåë"
            />
          </div>
        </GlassCard>
      </div>
    </section>

    <!-- Inauspicious Timings -->
    <section aria-label="Inauspicious Timings">
      <h2 class="text-lg font-semibold mb-4 flex items-center gap-2">
        <span aria-hidden="true">‚ö†Ô∏è</span>
        <span>Inauspicious Timings</span>
      </h2>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <!-- Rahu Kaal -->
        <a href={`/rahu-kaal/${city.slug}`} class="block group">
          <GlassCard variant="ashubh" padding="md" interactive class="text-center h-full">
            <div class="flex items-center justify-center gap-2 mb-2">
              <span class="text-xl" aria-hidden="true">‚ö†Ô∏è</span>
              <h3 class="font-semibold text-error">Rahu Kaal</h3>
              <StatusBadge status="ashubh" label="Avoid" size="xs" />
            </div>
            <p class="text-2xl font-bold text-error tabular-nums">
              {panchang.rahuKaal.start} - {panchang.rahuKaal.end}
            </p>
            <p class="text-sm text-neutral mt-1">Avoid new beginnings</p>
          </GlassCard>
        </a>

        <!-- Yamaganda -->
        <GlassCard variant="ashubh" padding="md" class="text-center">
          <div class="flex items-center justify-center gap-2 mb-2">
            <span class="text-xl" aria-hidden="true">‚è∞</span>
            <h3 class="font-semibold text-warning">Yamaganda</h3>
          </div>
          <p class="text-2xl font-bold text-warning tabular-nums">
            {panchang.yamaganda.start} - {panchang.yamaganda.end}
          </p>
          <p class="text-sm text-neutral mt-1">Avoid auspicious work</p>
        </GlassCard>

        <!-- Gulika Kaal -->
        <GlassCard variant="ashubh" padding="md" class="text-center">
          <div class="flex items-center justify-center gap-2 mb-2">
            <span class="text-xl" aria-hidden="true">‚è±Ô∏è</span>
            <h3 class="font-semibold text-warning">Gulika Kaal</h3>
          </div>
          <p class="text-2xl font-bold text-warning tabular-nums">
            {panchang.gulikaKaal.start} - {panchang.gulikaKaal.end}
          </p>
          <p class="text-sm text-neutral mt-1">Inauspicious period</p>
        </GlassCard>
      </div>
    </section>

    <!-- Related Links -->
    <section aria-label="Related Information" class="pt-4">
      <h2 class="text-lg font-semibold mb-4">More for {city.name}</h2>
      <div class="flex flex-wrap gap-3">
        <a href={`/rahu-kaal/${city.slug}`} class="btn btn-outline btn-sm">
          ‚ö†Ô∏è Rahu Kaal Details
        </a>
        <a href={`/choghadiya/${city.slug}`} class="btn btn-outline btn-sm">
          ‚è±Ô∏è Choghadiya
        </a>
        <a href="/muhurat" class="btn btn-outline btn-sm">
          üïê Shubh Muhurat
        </a>
        <a href="/festivals" class="btn btn-outline btn-sm">
          üéâ Festivals
        </a>
      </div>
    </section>

    <!-- Location Info -->
    <section class="text-sm text-neutral/60 pt-4 border-t border-base-300/50">
      <p>
        Panchang calculated for <strong>{city.name}, {city.state}</strong>
        (Lat: {city.latitude.toFixed(4)}¬∞, Long: {city.longitude.toFixed(4)}¬∞)
        using Lahiri Ayanamsa and Swiss Ephemeris.
      </p>
    </section>

    <!-- Popular Cities (SEO) -->
    <PopularCities
      pageType="panchang"
      title="Panchang for Other Cities"
      tier={2}
      limit={18}
      variant="compact"
    />
  </div>
</Layout>
