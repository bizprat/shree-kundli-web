---
/**
 * Layout Component (Legacy Compatibility)
 *
 * This is the original layout file updated to use the new cosmic theme
 * and component architecture. Provides backward compatibility for
 * existing pages while using the new design system.
 *
 * For new pages, prefer using Page.astro which provides more options.
 */

import '../styles/global.css';
import SEO from '../components/SEO.astro';
import Header from '../components/layout/Header.astro';
import Footer from '../components/layout/Footer.astro';
import BottomNav from '../components/layout/BottomNav.astro';
import CitySearchModal from '../components/islands/CitySearchModal.astro';

interface Props {
  title: string;
  description?: string;
  currentCity?: string;
  currentCitySlug?: string;
  activeNav?: 'home' | 'panchang' | 'festivals' | 'rashifal' | 'more';
  pageType?: string;
  lang?: 'en' | 'hi';
}

const {
  title,
  description = "Comprehensive Vedic Astrology & Panchang",
  currentCity,
  currentCitySlug,
  activeNav = 'home',
  pageType = 'panchang',
  lang = 'en',
} = Astro.props;

const currentPath = Astro.url.pathname;

// ─── Cloudflare auto-detection (SSR pages only) ─────────────────────────
// CF injects geo data on every request. On SSR pages we can read it to
// auto-detect the user's city for the Header display and modal suggestion.
let cfDetectedCity: string | undefined;
let cfDetectedSlug: string | undefined;
try {
  const cf = (Astro.locals as any).runtime?.cf;
  if (cf?.city) {
    cfDetectedCity = cf.city;
    cfDetectedSlug = cf.city.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '');
  }
} catch { /* SSG build — no runtime context */ }

// Use CF city as fallback when the page doesn't specify one
const headerCity = currentCity || cfDetectedCity;
const headerCitySlug = currentCitySlug || cfDetectedSlug;
---

<!doctype html>
<html lang={lang} data-theme="cosmic" class="scroll-smooth grain-overlay">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
    <meta name="theme-color" content="#0F0E1A" />
    <meta name="color-scheme" content="dark" />

    <!-- Preload critical font (regular weight used on every page) -->
    <link
      rel="preload"
      href="/fonts/inter-400.woff2"
      as="font"
      type="font/woff2"
      crossorigin="anonymous"
    />

    {lang === 'hi' && (
      <link
        rel="preload"
        href="/fonts/noto-sans-devanagari-400.woff2"
        as="font"
        type="font/woff2"
        crossorigin="anonymous"
      />
    )}

    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="icon" type="image/x-icon" href="/favicon.ico" />

    <SEO title={title} description={description} />
  </head>

  <body class="min-h-screen bg-base-100 text-base-content antialiased flex flex-col">
    <!-- Skip to main content -->
    <a
      href="#main-content"
      class="sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-4 focus:z-50 focus:px-4 focus:py-2 focus:bg-primary focus:text-primary-content focus:rounded-lg"
    >
      Skip to main content
    </a>

    <!-- Header -->
    <Header
      currentCity={headerCity}
      currentCitySlug={headerCitySlug}
      currentPath={currentPath}
    />

    <!-- City Search Modal (triggered by Header's "Select City" button) -->
    <CitySearchModal cfCity={cfDetectedCity} />

    <!-- Main Content -->
    <main
      id="main-content"
      class="grow w-full max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6"
    >
      <slot />
    </main>

    <!-- Footer -->
    <Footer currentPageType={pageType} lang={lang} />

    <!-- Bottom Navigation (Mobile Only) -->
    <BottomNav active={activeNav} />
  </body>
</html>

<style is:global>
  /* Screen reader only class */
  .sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border-width: 0;
  }
</style>
